<!DOCTYPE html>
<html lang="en">
<head>
    <title>Test webaudio</title>
</head>
<body>
<canvas id="oscilloscope"></canvas>

<script>
    const audioCtx = new AudioContext();
    if (navigator.mediaDevices) {
        navigator.mediaDevices.getUserMedia({"audio": true}).then(async (stream) => {
            const microphone = audioCtx.createMediaStreamSource(stream);

            await audioCtx.audioWorklet.addModule("custom-node-processor.js");
            const customNode = new AudioWorkletNode(
                audioCtx,
                "custom-node-processor"
            );
            //console.log(customNode.boh());

            const analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            // Connect the source to be analysed
            microphone.connect(customNode).connect(analyser);

            // Get a canvas defined with ID "oscilloscope"
            const canvas = document.getElementById("oscilloscope");
            const canvasCtx = canvas.getContext("2d");

            // draw an oscilloscope of the current audio source
            function draw() {
                requestAnimationFrame(draw);

                analyser.getByteTimeDomainData(dataArray);

                canvasCtx.fillStyle = "rgb(200, 200, 200)";
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = "rgb(0, 0, 0)";

                canvasCtx.beginPath();

                const sliceWidth = (canvas.width * 1.0) / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = (v * canvas.height) / 2;

                    if (i === 0) {
                        canvasCtx.moveTo(x, y);
                    } else {
                        canvasCtx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                canvasCtx.lineTo(canvas.width, canvas.height / 2);
                canvasCtx.stroke();
            }

            draw();
        }).catch((err) => {
            console.log(err);
        });
    } else {
        console.log("browser unable to access media devices");
    }
</script>
</body>
</html>